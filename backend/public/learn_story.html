<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tarot Tutor – Drag &amp; Drop Spread</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap + 自定义 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="d-flex flex-column min-vh-100">
  <nav class="navbar navbar-light bg-light px-3">
    <a class="navbar-brand" href="/">Tarot Tutor</a>
  </nav>

  <main class="container my-4">
    <!-- 拖拽交互区 -->
    <div class="text-center mb-4">
      <button id="get-card-btn" class="btn btn-primary">Card Source</button>
      <button id="clear-btn" class="btn btn-danger">Clear</button>
    </div>
    <div id="source-container" class="text-center mb-4"></div>

    <!-- 下拉题干 -->
    <div class="mb-4 text-center">
      <select id="question-select" class="form-select w-75 mx-auto">
        <option value="q1">
          What’s holding me back from finding the right partner, and how can I move forward?
        </option>
        <option value="q2">
          Is now a good time to change jobs or should I stay and wait for a promotion?
        </option>
      </select>
    </div>

    <!-- 三个拖放区 -->
    <div id="drop-container" class="row text-center">
      <div class="col-md-4 zone-container" data-zone="1">
        <h2>PAST</h2>
        <div class="drop-zone border rounded p-2 mb-2"></div>
        <div class="card-info"></div>
      </div>
      <div class="col-md-4 zone-container" data-zone="2">
        <h2>PRESENT</h2>
        <div class="drop-zone border rounded p-2 mb-2"></div>
        <div class="card-info"></div>
      </div>
      <div class="col-md-4 zone-container" data-zone="3">
        <h2>FUTURE</h2>
        <div class="drop-zone border rounded p-2 mb-2"></div>
        <div class="card-info"></div>
      </div>
    </div>

    <!-- 底部导航 -->
    <div class="d-flex justify-content-between my-4">
      <a href="/" class="btn btn-outline-secondary">Back</a>
      <a href="/quiz/1" class="btn btn-success">Next: Take the Quiz</a>
    </div>
  </main>

  <!-- 脚本区 -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // 日志函数
    function uid() {
      return localStorage.uid || (localStorage.uid = crypto.randomUUID());
    }
    function log(activity) {
      activity.userId = uid();
      $.ajax({
        url: "/log",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(activity)
      });
    }

    // 记录用户进入学习页（lesson_view）
    $(function() {
      log({ type: "lesson_view", page: "learn", lessonId: 2 });
    });

    // 拖拽逻辑
    const BACK_IMAGE = "/img/card-back.jpg";
    const getCardBtn  = document.getElementById("get-card-btn");
    const sourceCont  = document.getElementById("source-container");
    const dropZones   = document.querySelectorAll(".drop-zone");
    const clearBtn    = document.getElementById("clear-btn");
    let currentCard   = null;

    getCardBtn.addEventListener("click", async () => {
      if (currentCard) sourceCont.removeChild(currentCard);
      try {
        const res = await fetch("/api/getRandomCard");
        const card = await res.json();
        const img  = document.createElement("img");
        img.src    = BACK_IMAGE;
        img.className = "card-back";
        img.draggable = true;
        img.dataset.card = JSON.stringify(card);
        img.addEventListener("dragstart", e =>
          e.dataTransfer.setData("application/json", e.target.dataset.card)
        );
        sourceCont.appendChild(img);
        currentCard = img;
      } catch (err) {
        console.error(err);
        alert("Failed to fetch card");
      }
    });

    dropZones.forEach(zone => {
      zone.addEventListener("dragover", e => {
        e.preventDefault();
        zone.classList.add("hover");
      });
      zone.addEventListener("dragleave", () => zone.classList.remove("hover"));
      zone.addEventListener("drop", e => {
        e.preventDefault();
        zone.classList.remove("hover");
        const data = e.dataTransfer.getData("application/json");
        if (!data) return;
        const card = JSON.parse(data);
        zone.innerHTML = "";
        const img  = document.createElement("img");
        img.src    = BACK_IMAGE;
        img.className = "card-back";
        img.dataset.card = JSON.stringify(card);
        zone.appendChild(img);

        const infoDiv = zone.parentElement.querySelector(".card-info");
        infoDiv.innerHTML = "";

        img.addEventListener("click", () => {
          zone.innerHTML = "";
          const front = document.createElement("img");
          front.src = card.image;
          front.className = "card-front";
          zone.appendChild(front);
          infoDiv.innerHTML =
            `<h3>${card.name}</h3>` +
            `<p>${card.description}</p>` +
            `<p class="love-meaning">${card.loveMeaning}</p>`;
        });

        if (currentCard) {
          sourceCont.removeChild(currentCard);
          currentCard = null;
        }
      });
    });

    clearBtn.addEventListener("click", () => {
      dropZones.forEach(z => (z.innerHTML = ""));
      document
        .querySelectorAll(".card-info")
        .forEach(div => (div.innerHTML = ""));
      if (currentCard) {
        sourceCont.removeChild(currentCard);
        currentCard = null;
      }
    });
  </script>
</body>
</html>
