<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tarot Tutor · Three‑Card Practice</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Main Styles -->
  <link rel="stylesheet" href="/css/styles.css">

  <style>
    /* ==========  基础  ========== */
    body {
      font-family: 'Lora', serif;
      background: url('/img/bg.png') no-repeat center/cover fixed;
      color: #f8e7c1;
      min-height: 100vh;
    }

    /* ========== 页面元素 ========== */
    .button-container { text-align: center; margin: 1.5rem 0; }
    #source-container img { width: 120px; height: 200px; cursor: grab; }
    .question-container { margin-bottom: 2rem; text-align: center; }

    #drop-container {
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }
    /* Past/Present/Future 头部使用明黄色 */
    .zone-container { text-align: center; width: 200px; }
    .zone-container h2 { color: #f9d451; font-size: 1.25rem; margin-bottom: .5rem; }

    .drop-zone {
      width: 100%;
      height: 200px;
      border: 2px dashed #f9d451;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .2s;
      overflow: hidden;
    }
    .drop-zone.hover { background: rgba(249,212,81,.15); }
    .drop-zone img { width: 100%; height: 100%; object-fit: cover; }

    /* 卡片说明文字使用暗黄色 */
    .card-info { font-size: .95rem; line-height: 1.4; margin-top: .5rem; color: #e2d2ad !important; }

    .navigation-buttons { display: flex; justify-content: space-between; margin-top: 2rem; }
    .navigation-buttons .btn { min-width: 180px; }
  </style>
</head>
<body>
  <!-- ======== Navigation ======== -->
  <nav class="custom-nav">
    <a href="/">Tarot Tutor</a>
    <a href="/about.html">About Three Spread</a>
    <a href="/learn_story.html">Learning</a>
    <a href="/quiz">Quiz</a>
  </nav>

  <!-- ======== Content ======== -->
  <div class="container py-4">
    <div class="button-container">
      <button id="get-card-btn" class="btn btn-primary me-2">Card Source</button>
      <button id="clear-btn" class="btn btn-danger">Clear</button>
    </div>

    <div id="source-container" class="text-center mb-4"></div>

    <div class="question-container">
      <select id="question-select" class="form-select w-75 mx-auto">
        <option value="q1">What's holding me back from finding the right partner, and how can I move forward?</option>
        <option value="q2">Is now a good time to change jobs or should I stay and wait for a promotion?</option>
      </select>
    </div>

    <div id="drop-container">
      <div class="zone-container" data-zone="past">
        <h2>PAST</h2>
        <div class="drop-zone"></div>
        <div class="card-info"></div>
      </div>
      <div class="zone-container" data-zone="present">
        <h2>PRESENT</h2>
        <div class="drop-zone"></div>
        <div class="card-info"></div>
      </div>
      <div class="zone-container" data-zone="future">
        <h2>FUTURE</h2>
        <div class="drop-zone"></div>
        <div class="card-info"></div>
      </div>
    </div>

    <div class="navigation-buttons">
      <a href="/about.html" class="btn btn-outline-secondary">Back</a>
      <button id="reveal-btn" class="btn btn-primary">Submit and Reveal Answers</button>
      <a href="/learn_advanced.html" class="btn btn-success">Next: Advanced Concepts</a>
    </div>

    <div class="footer-nav">
      <a href="/index.html">Back</a>
      <a href="/learn_advanced.html">Next: Advanced Concepts</a>
    </div>
  </div>

  <!-- ======== Scripts ======== -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const BACK_IMAGE = '/img/card-back.jpg';
    const getCardBtn = document.getElementById('get-card-btn');
    const sourceContainer = document.getElementById('source-container');
    const dropZones = document.querySelectorAll('.drop-zone');
    const clearBtn = document.getElementById('clear-btn');
    let currentCard = null;

    /* 生成随机牌背 */
    getCardBtn.addEventListener('click', async () => {
      if (currentCard) sourceContainer.removeChild(currentCard);
      try {
        const res = await fetch('/api/getRandomCard');
        const card = await res.json();
        const img = document.createElement('img');
        img.src = BACK_IMAGE;
        img.draggable = true;
        img.dataset.card = JSON.stringify(card);
        img.addEventListener('dragstart', e => e.dataTransfer.setData('application/json', img.dataset.card));
        sourceContainer.appendChild(img);
        currentCard = img;
      } catch {
        alert('Failed to fetch card');
      }
    });

    /* 拖拽逻辑 */
    dropZones.forEach(zone => {
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('hover'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('hover'));  
      zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('hover');
        const data = e.dataTransfer.getData('application/json');
        if (!data) return;
        const card = JSON.parse(data);

        zone.innerHTML = '';
        const backImg = document.createElement('img');
        backImg.src = BACK_IMAGE;
        backImg.dataset.card = JSON.stringify(card);
        zone.appendChild(backImg);

        const infoDiv = zone.nextElementSibling;
        backImg.addEventListener('click', () => showFront(zone, infoDiv, card));

        if (currentCard) { sourceContainer.removeChild(currentCard); currentCard = null; }
      });
    });

    /* 清空 */
    clearBtn.addEventListener('click', () => {
      dropZones.forEach(z => { z.innerHTML = ''; z.nextElementSibling.innerHTML = ''; });
      if (currentCard) { sourceContainer.removeChild(currentCard); currentCard = null; }
    });

    /* Reveal */
    document.getElementById('reveal-btn').addEventListener('click', () => {
      dropZones.forEach(zone => {
        const img = zone.querySelector('img');
        if (!img || !img.dataset.card) return;
        const card = JSON.parse(img.dataset.card);
        showFront(zone, zone.nextElementSibling, card);
      });
    });

    function showFront(zone, infoDiv, card) {
      zone.innerHTML = `<img src="${card.image}" class="card-front"/>`;
      const meaning = card.meaning_up || card.description || '';
      infoDiv.innerHTML = `<h3>${card.name}</h3><p>${meaning}</p>`;
    }
  </script>
</body>
</html>
